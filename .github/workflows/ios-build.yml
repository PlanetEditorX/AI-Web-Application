name: "Build iOS IPA"

on:
  push:
    branches: [ "main" ] # 或者是你的主分支名

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # 1. 安装项目依赖
      - name: Install dependencies
        run: |
          npm install
          cd ios && pod install && cd ..

      # 2. 解密并安装证书与描述文件 (关键步骤)
      - name: Install the Apple certificate and provisioning profile
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.P12_DIST_CERT }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.PROVISIONING_PROFILE }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # 创建临时钥匙串并导入证书
          # 这里通常会运行一段脚本来把 Base64 转回文件并存入系统
          # 建议使用现成的 Action 如 apple-actions/import-codesign-certs@v3

      # 3. 编译 Archive 并导出 IPA
      - name: Build IPA
        run: |
          xcodebuild -workspace ios/GeminiClient.xcworkspace \
                     -scheme GeminiClient \
                     -sdk iphoneos \
                     -configuration Release \
                     -archivePath $PWD/build/GeminiClient.xcarchive \
                     archive

          xcodebuild -exportArchive \
                     -archivePath $PWD/build/GeminiClient.xcarchive \
                     -exportOptionsPlist ios/ExportOptions.plist \
                     -exportPath $PWD/build/ipa

      # 4. 上传生成的 IPA 到 GitHub Release 或 Artifacts
      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: build/ipa/*.ipa